// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User/Member model - synced with Clerk
model User {
  id                String         @id @default(cuid())
  clerkUserId       String         @unique
  email             String         // Not unique - same email can have multiple accounts
  firstName         String?
  lastName          String?
  affiliateCode     String         // Removed @unique to allow shared codes
  isTeamLeader      Boolean        @default(false) // True if this user created the affiliate code
  affiliateCodeUpdatedAt DateTime?  // Track last time affiliate code was changed
  affiliateCodeHistory String[]     @default([]) // Track history of previous codes
  isAdmin           Boolean        @default(false)
  points            Int            @default(0)
  loyaltyPoints     Int            @default(0)
  loyaltyLevel      String         @default("Bronze") // Bronze, Silver, Gold, Platinum
  totalReferrals    Int            @default(0)
  totalEarnings     Decimal        @default(0) @db.Decimal(10, 2)
  
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  
  // Relations
  reservations      Reservation[]
  referrals         Reservation[]  @relation("ReferredBy")
  transactions      Transaction[]
  voucherRedemptions VoucherRedemption[]
  eventRegistrations EventRegistration[]
  bankAccounts      BankAccount[]
  withdrawals       Withdrawal[]

  @@map("users")
}

// Pre-claim affiliate codes - codes created by admin that can be claimed later
model PreClaimAffiliateCode {
  id              String    @id @default(cuid())
  code            String    @unique // The affiliate code (e.g., AFMRCH1)
  assignedEmail   String?   // Email assigned by FO for ownership
  claimedBy       String?   // User ID who claimed this code
  claimedAt       DateTime? // When the code was claimed
  usageCount      Int       @default(0) // How many times used in reservations
  status          String    @default("unclaimed") // unclaimed, claimed
  notes           String?   // Admin notes about this code
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  createdBy       String?   // Admin who created this code

  @@map("pre_claim_affiliate_codes")
}

// Treatment categories and items
model TreatmentCategory {
  id          String      @id @default(cuid())
  name        String
  slug        String      @unique
  description String?
  image       String?
  order       Int         @default(0)
  active      Boolean     @default(true)
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  treatments  Treatment[]

  @@map("treatment_categories")
}

model Treatment {
  id              String            @id @default(cuid())
  categoryId      String
  name            String
  slug            String            @unique
  description     String?
  price           Decimal           @db.Decimal(10, 2)
  duration        Int?              // in minutes
  image           String?
  benefits        String[]
  active          Boolean           @default(true)
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  category        TreatmentCategory @relation(fields: [categoryId], references: [id])
  reservations    Reservation[]

  @@map("treatments")
}

// Reservation system
model Reservation {
  id              String    @id @default(cuid())
  userId          String?   // Nullable for guest reservations
  treatmentId     String
  referredBy      String?   // Affiliate code of referrer
  referrerId      String?   // User ID of referrer
  
  // Patient info
  patientName     String
  patientEmail    String
  patientPhone    String
  patientNotes    String?
  
  // Reservation details
  reservationDate DateTime
  reservationTime String
  status          String    @default("pending") // pending, confirmed, completed, cancelled
  
  // Pricing
  originalPrice   Decimal   @db.Decimal(10, 2)
  finalPrice      Decimal   @db.Decimal(10, 2)
  discountAmount  Decimal   @default(0) @db.Decimal(10, 2)
  
  // Affiliate commission
  commissionAmount Decimal  @default(0) @db.Decimal(10, 2)
  commissionPaid   Boolean  @default(false)
  
  // Admin notes
  adminNotes      String?
  completedAt     DateTime?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  user            User?     @relation(fields: [userId], references: [id])
  treatment       Treatment @relation(fields: [treatmentId], references: [id])
  referrer        User?     @relation("ReferredBy", fields: [referrerId], references: [id])

  @@map("reservations")
}

// Transaction history
model Transaction {
  id              String    @id @default(cuid())
  userId          String
  type            String    // commission, voucher_redeem, points_earned
  amount          Decimal   @db.Decimal(10, 2)
  points          Int       @default(0)
  description     String
  referenceId     String?   // ID of related reservation/voucher/etc
  
  createdAt       DateTime  @default(now())
  
  user            User      @relation(fields: [userId], references: [id])

  @@map("transactions")
}

// Voucher system
model Voucher {
  id              String      @id @default(cuid())
  title           String
  description     String?
  category        String      // Treatment, Product, Service
  discount        String      // "50%", "100%"
  pointsCost      Int
  availableCount  Int
  image           String?
  active          Boolean     @default(true)
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  redemptions     VoucherRedemption[]

  @@map("vouchers")
}

model VoucherRedemption {
  id          String    @id @default(cuid())
  userId      String
  voucherId   String
  code        String    @unique // Generated redemption code
  status      String    @default("active") // active, used, expired
  usedAt      DateTime?
  
  createdAt   DateTime  @default(now())
  expiresAt   DateTime
  
  user        User      @relation(fields: [userId], references: [id])
  voucher     Voucher   @relation(fields: [voucherId], references: [id])

  @@map("voucher_redemptions")
}

// Event system
model Event {
  id              String      @id @default(cuid())
  title           String
  description     String
  date            DateTime
  loyaltyLevel    String      // All Members, Silver, Gold, Platinum
  image           String?
  totalSlots      Int
  availableSlots  Int
  active          Boolean     @default(true)
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  registrations   EventRegistration[]

  @@map("events")
}

model EventRegistration {
  id          String    @id @default(cuid())
  userId      String
  eventId     String
  status      String    @default("registered") // registered, attended, cancelled
  
  createdAt   DateTime  @default(now())
  
  user        User      @relation(fields: [userId], references: [id])
  event       Event     @relation(fields: [eventId], references: [id])

  @@unique([userId, eventId])
  @@map("event_registrations")
}

// Bank Account - Store user's bank/e-wallet info
model BankAccount {
  id              String    @id @default(cuid())
  userId          String
  accountType     String    // "bank" or "ewallet"
  bankName        String    // Mandiri, BRI, BCA, BSI, CIMBNIAGA, BPD DIY, DANA, GOPAY, SHOPEEPAY, OVO
  accountNumber   String
  accountName     String
  isDefault       Boolean   @default(false)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  user            User      @relation(fields: [userId], references: [id])
  withdrawals     Withdrawal[]

  @@map("bank_accounts")
}

// Withdrawal Request - Commission withdrawal by affiliators
model Withdrawal {
  id              String    @id @default(cuid())
  userId          String
  bankAccountId   String
  amount          Decimal   @db.Decimal(10, 2)
  status          String    @default("pending") // pending, approved, rejected, completed
  requestDate     DateTime  @default(now())
  processedDate   DateTime?
  processedBy     String?   // Admin user ID who processed
  adminNotes      String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  user            User         @relation(fields: [userId], references: [id])
  bankAccount     BankAccount  @relation(fields: [bankAccountId], references: [id])

  @@map("withdrawals")
}
